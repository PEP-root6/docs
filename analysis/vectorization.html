
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Part 6 - Vectorization Â· PEP root6 workshop</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panels/panels.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-block-align/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../css/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="declarative.html" />
    
    
    <link rel="prev" href="changes.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="introduction.html">
            
                <a href="introduction.html">
            
                    
                    Part 1 - Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="feat1.html">
            
                <a href="feat1.html">
            
                    
                    Part 2 - New C++ features 1
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="feat2.html">
            
                <a href="feat2.html">
            
                    
                    Part 3 - Smart (and dumb) pointers
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="newf2/intro.html">
            
                <a href="newf2/intro.html">
            
                    
                    Pointers, the absolute basics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="newf2/introexer.html">
            
                <a href="newf2/introexer.html">
            
                    
                    A quick refresher
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="newf2/smartp.html">
            
                <a href="newf2/smartp.html">
            
                    
                    Smart pointers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="newf2/exer.html">
            
                <a href="newf2/exer.html">
            
                    
                    Exercises
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="parallellism.html">
            
                <a href="parallellism.html">
            
                    
                    Part 4 - Parallellism
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="parallell/intro.html">
            
                <a href="parallell/intro.html">
            
                    
                    Threads and processes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="parallell/example.html">
            
                <a href="parallell/example.html">
            
                    
                    Posix multithreading
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="parallell/caveats.html">
            
                <a href="parallell/caveats.html">
            
                    
                    What can go wrong?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="parallell/root.html">
            
                <a href="parallell/root.html">
            
                    
                    Parallellism with ROOT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="changes.html">
            
                <a href="changes.html">
            
                    
                    Part 5 - 5 to 6: changes to user code
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7" data-path="vectorization.html">
            
                <a href="vectorization.html">
            
                    
                    Part 6 - Vectorization
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="declarative.html">
            
                <a href="declarative.html">
            
                    
                    Part 7 - Declarative analysis
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="python/">
            
                <a href="python/">
            
                    
                    Part 8 - Python
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="python/running.html">
            
                <a href="python/running.html">
            
                    
                    Running
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="python/operators.html">
            
                <a href="python/operators.html">
            
                    
                    Objects and operators
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="python/numbers.html">
            
                <a href="python/numbers.html">
            
                    
                    Numbers
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="python/strings.html">
            
                <a href="python/strings.html">
            
                    
                    Strings
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="python/lists.html">
            
                <a href="python/lists.html">
            
                    
                    Lists and looping
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="python/dictionaries.html">
            
                <a href="python/dictionaries.html">
            
                    
                    Dictionaries
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="python/conditions.html">
            
                <a href="python/conditions.html">
            
                    
                    Conditions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.8" data-path="python/methods.html">
            
                <a href="python/methods.html">
            
                    
                    Methods
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.9" data-path="python/scripting.html">
            
                <a href="python/scripting.html">
            
                    
                    Scripting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.10" data-path="python/modules.html">
            
                <a href="python/modules.html">
            
                    
                    Modules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.11" data-path="python/learning.html">
            
                <a href="python/learning.html">
            
                    
                    Learning more
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.12" data-path="python/pyroot.html">
            
                <a href="python/pyroot.html">
            
                    
                    PyROOT
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="bestprac/best_prac.html">
            
                <a href="bestprac/best_prac.html">
            
                    
                    Part 9 - Best Practices
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.10.1" data-path="bestprac/preparing.html">
            
                <a href="bestprac/preparing.html">
            
                    
                    Preparing your code for debugging
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.2" data-path="bestprac/general.html">
            
                <a href="bestprac/general.html">
            
                    
                    Some general programming tips
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.3" data-path="bestprac/crash.html">
            
                <a href="bestprac/crash.html">
            
                    
                    Where does my code crash
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10.4" data-path="bestprac/memory.html">
            
                <a href="bestprac/memory.html">
            
                    
                    Finding memory leaks
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Part 6 - Vectorization</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="vectorization">Vectorization</h1>
<p>Vectorization is a topic that we will cover only very briefly, mostly to make you aware of its existence. </p>
<h2 id="what-is-vectorization">What is vectorization?</h2>
<p>Vectorization is a special case of automatic parallelization, where a computer program is converted from a scalar implementation, which processes a single pair of operands at a time, to a vector implementation, which processes one operation on multiple pairs of operands at once. For example, modern conventional computers, including specialized supercomputers, typically have vector operations that simultaneously perform operations such as the following four additions (via SIMD or SPMD hardware): </p>
<p>An example would be a program to multiply two vectors of numeric data. A scalar approach would be something like: </p>
<pre><code class="lang-cpp"> <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i++)
    C[i] = A[i]*B[i];
</code></pre>
<p>This could be vectorized to look something like: </p>
<pre><code class="lang-cpp">  <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1024</span>; i+=<span class="hljs-number">4</span>)
     C[i:i+<span class="hljs-number">3</span>] = A[i:i+<span class="hljs-number">3</span>]*B[i:i+<span class="hljs-number">3</span>];
</code></pre>
<p>Here, C[i:i+3] represents the four array elements from C[i] to C[i+3] and the vector processor can perform four operations for a single vector instruction. Since the four vector operations complete in roughly the same time as one scalar instruction, the vector approach can run up to four times faster than the original code.</p>
<h2 id="how-is-this-helpful-">How is this helpful ?</h2>
<p>Single instruction, multiple data (SIMD) is a class of parallel computers in Flynn&apos;s taxonomy. It describes computers with multiple processing elements that perform the same operation on multiple data points simultaneously. Such machines exploit data level parallelism, but not concurrency: there are simultaneous (parallel) computations, but only a single process (instruction) at a given moment. SIMD is particularly applicable to common tasks such as adjusting the contrast in a digital image or adjusting the volume of digital audio. Most modern CPU designs include SIMD instructions to improve the performance of multimedia use. Not to be confused with SIMT which utilizes threads. </p>
<h3 id="advantages">Advantages</h3>
<p>An application that may take advantage of SIMD is one where the same value is being added to (or subtracted from) a large number of data points, a common operation in many multimedia applications. One example would be changing the brightness of an image. Each pixel of an image consists of three values for the brightness of the red (R), green (G) and blue (B) portions of the color. To change the brightness, the R, G and B values are read from memory, a value is added to (or subtracted from) them, and the resulting values are written back out to memory.</p>
<p>With a SIMD processor there are two improvements to this process. For one the data is understood to be in blocks, and a number of values can be loaded all at once. Instead of a series of instructions saying &quot;retrieve this pixel, now retrieve the next pixel&quot;, a SIMD processor will have a single instruction that effectively says &quot;retrieve n pixels&quot; (where n is a number that varies from design to design). For a variety of reasons, this can take much less time than retrieving each pixel individually, as with traditional CPU design.</p>
<p>Another advantage is that the instruction operates on all loaded data in a single operation. In other words, if the SIMD system works by loading up eight data points at once, the add operation being applied to the data will happen to all eight values at the same time. This parallelism is separate from the parallelism provided by a superscalar processor; the eight values are processed in parallel even on a non-superscalar processor, and a superscalar processor may be able to perform multiple SIMD operations in parallel. </p>
<h3 id="disadvantages">Disadvantages</h3>
<p>Not all algorithms can be vectorized easily. For example, a flow-control-heavy task like code parsing may not easily benefit from SIMD; however, it is theoretically possible to vectorize comparisons and &quot;batch flow&quot; to target maximal cache optimality, though this technique will require more intermediate state. Note: Batch-pipeline systems (example: GPUs or software rasterization pipelines) are most advantageous for cache control when implemented with SIMD intrinsics, but they are not exclusive to SIMD features. Further complexity may be apparent to avoid dependence within series such as code strings; while independence is required for vectorization.
Large register files which increases power consumption and require chip area.
Currently, implementing an algorithm with SIMD instructions usually requires human labor; most compilers don&apos;t generate SIMD instructions from a typical C program, for instance. Automatic vectorization in compilers is an active area of computer science research. (Compare vector processing.)</p>
<h2 id="hardware">Hardware</h2>
<p>Small-scale (64 or 128 bits) SIMD became popular on general-purpose CPUs in the early 1990s and continued through 1997 and later with Motion Video Instructions (MVI) for Alpha. SIMD instructions can be found, to one degree or another, on most CPUs, including the IBM&apos;s AltiVec and SPE for PowerPC, HP&apos;s PA-RISC Multimedia Acceleration eXtensions (MAX), Intel&apos;s MMX and iwMMXt, SSE, SSE2, SSE3 SSSE3 and SSE4.x, AMD&apos;s 3DNow!, ARC&apos;s ARC Video subsystem, SPARC&apos;s VIS and VIS2, Sun&apos;s MAJC, ARM&apos;s NEON technology, MIPS&apos; MDMX (MaDMaX) and MIPS-3D. The IBM, Sony, Toshiba co-developed Cell Processor&apos;s SPU&apos;s instruction set is heavily SIMD based. NXP founded by Philips developed several SIMD processors named Xetal. The Xetal has 320 16bit processor elements especially designed for vision tasks.</p>
<p>Modern graphics processing units (GPUs) are often wide SIMD implementations, capable of branches, loads, and stores on 128 or 256 bits at a time.</p>
<p>Intel&apos;s AVX SIMD instructions now process 256 bits of data at once. Intel&apos;s Larrabee prototype microarchitecture includes more than two 512-bit SIMD registers on each of its cores (VPU: Wide Vector Processing Units), and this 512-bit SIMD capability is being continued in Intel&apos;s Many Integrated Core Architecture (Intel MIC) and Skylake-X. </p>
<h1 id="vectorization-support-in-root">Vectorization support in ROOT</h1>
<ul>
<li>Integration of VecCore in ROOT as the common vector abstraction in HEP<ul>
<li>Definition of new ROOT SIMD types: ROOT::Double_v, ROOT::Float_v.</li>
</ul>
</li>
<li>Adaptation of TF1 to evaluate functions evaluating over vector types.</li>
<li>Adaptation of the fitting classes and interfaces in ROOT to accept the new</li>
<li>SIMD types and functions implementing them.</li>
<li>Parallelization of the fitting objective functions (Max. Likelihood, Least
Squares)</li>
</ul>
<p>TFormula supports vectorization. All the TF1 objected created with a formula expression can have a vectorized signature using ROOT::Double_v: TF1::EvalPar( ROOT::Double_v <em> x, double </em> p). The vectorization can then be used to speed-up fitting. It is not enabled by default, but it can be enabled by callig TF1::SetVectorized(true) or using the &quot;VEC&quot; option in the constructor of TF1, when ROOT has been built with VecCore and one vectorization library such as Vc.</p>
<pre><code class="lang-cpp"><span class="hljs-comment">//Higgs Fit: Implementation of the scalar function</span>
<span class="hljs-function"><span class="hljs-keyword">double</span> <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">double</span> *data, <span class="hljs-keyword">const</span> <span class="hljs-keyword">double</span> *params)</span>
</span>{
<span class="hljs-keyword">return</span> params[<span class="hljs-number">0</span>] * <span class="hljs-built_in">exp</span>(-(*data + (<span class="hljs-number">-130.</span>)) * (*data + (<span class="hljs-number">-130.</span>)) / <span class="hljs-number">2</span>) +
params[<span class="hljs-number">1</span>] * <span class="hljs-built_in">exp</span>(-(params[<span class="hljs-number">2</span>] * (*data * (<span class="hljs-number">0.01</span>)) - params[<span class="hljs-number">3</span>] *
((*data) * (<span class="hljs-number">0.01</span>)) * ((*data) * (<span class="hljs-number">0.01</span>))));
}
TF1 *f = <span class="hljs-keyword">new</span> TF1(&#x201D;fScalar&#x201D;, func, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>, <span class="hljs-number">4</span>);
f-&gt;SetParameters(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">7.5</span>, <span class="hljs-number">1.5</span>);
<span class="hljs-function">TH1D <span class="hljs-title">h1f</span><span class="hljs-params">(&#x201D;h1f&#x201D;, &#x201D;Test random numbers&#x201D;, <span class="hljs-number">12800</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>)</span></span>;
h1f.FillRandom(&#x201D;fvScalar&#x201D;, <span class="hljs-number">1000000</span>);
h1f.Fit(f);
</code></pre>
<p>in the vectorized approach</p>
<pre><code class="lang-cpp"><span class="hljs-comment">//Higgs Fit: Implementation of the vectorized function</span>
ROOT::<span class="hljs-function">Double_v <span class="hljs-title">func</span><span class="hljs-params">(<span class="hljs-keyword">const</span> ROOT::Double_v *data, <span class="hljs-keyword">const</span> <span class="hljs-keyword">double</span> *params)</span>
</span>{
<span class="hljs-keyword">return</span> params[<span class="hljs-number">0</span>] * <span class="hljs-built_in">exp</span>(-(*data + (<span class="hljs-number">-130.</span>)) * (*data + (<span class="hljs-number">-130.</span>)) / <span class="hljs-number">2</span>) +
params[<span class="hljs-number">1</span>] * <span class="hljs-built_in">exp</span>(-(params[<span class="hljs-number">2</span>] * (*data * (<span class="hljs-number">0.01</span>)) - params[<span class="hljs-number">3</span>] *
((*data) * (<span class="hljs-number">0.01</span>)) * ((*data) * (<span class="hljs-number">0.01</span>))));
}
<span class="hljs-comment">//This code is totally backwards compatible</span>
TF1 *f = <span class="hljs-keyword">new</span> TF1(&#x201D;fvCore&#x201D;, func, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>, <span class="hljs-number">4</span>);
f-&gt;SetParameters(<span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">7.5</span>, <span class="hljs-number">1.5</span>);
<span class="hljs-function">TH1D <span class="hljs-title">h1f</span><span class="hljs-params">(&#x201D;h1f&#x201D;, &#x201D;Test random numbers&#x201D;, <span class="hljs-number">12800</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>)</span></span>;
h1f.FillRandom(&#x201D;fvCore&#x201D;, <span class="hljs-number">1000000</span>);
<span class="hljs-comment">//Added multithreaded fit option</span>
h1f.Fit(f, &#x201D;MULTITHREAD&#x201D;);
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="changes.html" class="navigation navigation-prev " aria-label="Previous page: Part 5 - 5 to 6: changes to user code">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="declarative.html" class="navigation navigation-next " aria-label="Next page: Part 7 - Declarative analysis">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Part 6 - Vectorization","level":"1.7","depth":1,"next":{"title":"Part 7 - Declarative analysis","level":"1.8","depth":1,"path":"analysis/declarative.md","ref":"analysis/declarative.md","articles":[]},"previous":{"title":"Part 5 - 5 to 6: changes to user code","level":"1.6","depth":1,"path":"analysis/changes.md","ref":"analysis/changes.md","articles":[]},"dir":"ltr"},"config":{"plugins":["katex","panels@git+https://github.com/lhcb/gitbook-plugin-panels.git#117012fdc18c96831cb88196980c0ea73b0c87b8","collapsible-menu","block-align"],"styles":{"website":"css/website.css"},"pluginsConfig":{"collapsible-menu":{},"block-align":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"panels":{},"katex":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"PEP root6 workshop","gitbook":"*","description":"PEP root6 introduction material"},"file":{"path":"analysis/vectorization.md","mtime":"2018-11-07T16:08:39.428Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-11-07T16:33:05.338Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-panels/panels.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

